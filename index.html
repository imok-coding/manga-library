<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
<title>Tyler's Manga Library</title>
<style>
/* ===== BODY & BASE ===== */
:root {
    --bg: #1e0d14;
    --card-bg: #2b0f1d;
    --accent: #ffb6c1;
    --accent-strong: #ff69b4;
    --muted: rgba(255,182,193,0.15);
    --read-glow: rgba(255,105,180,0.5);
    --unread-glow: rgba(255,182,193,0.12);
    --text: #fff;
}
* { box-sizing: border-box; }
body {
    background: var(--bg);
    color: var(--text);
    font-family: Helvetica, Arial, sans-serif;
    margin: 0;
    padding: 0;
}
html { scroll-behavior: smooth; }
.container { max-width: 1200px; margin: 0 auto; padding: 20px; position: relative; z-index: 1; }
header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:10px; }
h1 { text-align: left; color: var(--accent); margin:0; font-size:20px; text-shadow: 0 0 6px rgba(255,182,193,0.7); }

/* ===== COUNTERS ===== */
.counter { display:flex; gap:12px; align-items:center; justify-content:center; margin:8px 0 12px 0; }
.counter span { padding:6px 12px; border-radius:12px; background:transparent; color: #f8f0f4; font-weight:600; cursor:pointer; }
.counter .total { color: var(--accent); border:1px solid rgba(255,182,193,0.06); padding:6px 12px; border-radius:12px; }
.counter .read { color: #ccc; }

/* ===== SEARCH INPUT ===== */
#searchInput { width: 90%; max-width: 520px; margin: 6px auto; display:block; padding:10px; font-size:14px; border-radius:10px; border:1px solid rgba(255,182,193,0.08); background:#2b0f1d; color:#fff; box-shadow: 0 0 6px rgba(255,182,193,0.06) inset; }

/* ===== GRID & CARDS ===== */
.grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:20px; justify-items:center; padding: 18px 0; transition: all 0.25s ease; }
.card { background: var(--card-bg); border-radius:12px; overflow:hidden; text-align:center; transition: transform 0.15s, box-shadow 0.25s ease; cursor:pointer; box-shadow: 0 2px 8px rgba(255,182,193,0.08); width:100%; max-width:150px; }
.card:hover { transform: scale(1.04); box-shadow: 0 0 15px rgba(255,182,193,0.18); }
.card.read { box-shadow: 0 0 10px var(--read-glow), 0 0 6px rgba(255,182,193,0.18); border:1px solid rgba(255,105,180,0.14); }
.card:not(.read) { box-shadow: 0 0 6px var(--unread-glow); } /* subtle unread glow */
.card:not(.read):hover { box-shadow: 0 0 10px rgba(255,182,193,0.2); }
.card img { width:100%; height:220px; object-fit:cover; display:block; margin:0 auto; background:#3b1a28; border-radius:6px; }
.card .title { font-weight:700; margin:6px 8px; font-size:13px; min-height:36px; color:var(--accent); }
.card .meta { font-size:11px; margin:4px 6px; color:#f0cfd6; padding-bottom:8px; }
.card .isbn { font-size:10px; color:#eaa4b7; margin-top:4px; }

/* ===== POPUP ===== */
#popupOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(30,13,20,0.95); backdrop-filter: blur(6px); display:none; justify-content:center; align-items:center; z-index:9999; }
#popupContent { background: var(--card-bg); padding:20px; border-radius:16px; max-width:900px; width:92%; color:var(--text); position:relative; display:flex; gap:20px; align-items:center; box-shadow: 0 0 25px rgba(255,182,193,0.15); }
#popupContent img { max-width:220px; height:auto; border-radius:8px; flex-shrink:0; box-shadow: 0 0 12px rgba(255,182,193,0.12); }
.popup-info { display:flex; flex-direction:column; gap:10px; flex:1; text-align:center; padding-left:8px; padding-right:8px; }
.popup-info .title { font-size:18px; font-weight:800; color:var(--accent); }
.popup-info .meta { font-size:14px; color:#f0d6dd; line-height:1.4; }
.popup-info .isbn { font-size:12px; color:#eea4b7; }
#popupContent.read { border:1px solid rgba(255,105,180,0.14); box-shadow: 0 0 30px rgba(255,105,180,0.18); }
#popupClose { position:absolute; top:12px; right:12px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.06); color:#fff; font-size:18px; font-weight:700; border-radius:8px; width:36px; height:36px; cursor:pointer; transition:background 0.2s, transform 0.1s; }
#popupClose:hover { background: rgba(255,182,193,0.14); transform:scale(1.06); }

/* BUY BUTTON */
.buy-btn { display:inline-block; margin-top:6px; padding:8px 14px; border-radius:8px; text-decoration:none; font-weight:700; background:linear-gradient(180deg,var(--accent-strong),#ff84b2); color:#fff; box-shadow:0 6px 12px rgba(255,105,180,0.12); }

/* ===== HAMBURGER + RIGHT PANEL (Wishlist) ===== */
.hamburger { width:44px; height:44px; border-radius:8px; display:flex; align-items:center; justify-content:center; cursor:pointer; background:transparent; border:1px solid rgba(255,182,193,0.04); }
.hamburger .bar { width:20px; height:2px; background:var(--accent); transition: transform 0.25s, opacity 0.2s; display:block; position:relative; }
.hamburger .bar::before, .hamburger .bar::after { content:''; position:absolute; left:0; width:20px; height:2px; background:var(--accent); transition: transform 0.25s, top 0.25s, bottom 0.25s; }
.hamburger .bar::before { top:-6px; }
.hamburger .bar::after { bottom:-6px; }
.hamburger.open .bar { background:transparent; }
.hamburger.open .bar::before { transform: rotate(45deg); top:0; }
.hamburger.open .bar::after { transform: rotate(-45deg); bottom:0; }

/* right panel */
.right-panel { position:fixed; top:0; right:-100%; width:100%; max-width:420px; height:100%; background: #1a0710; box-shadow: -8px 0 30px rgba(0,0,0,0.6); transition: right 0.35s cubic-bezier(.2,.9,.2,1); z-index: 10001; padding:18px 14px; overflow:auto; }
.right-panel.open { right:0; }
.right-panel header { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:12px; }

/* panel content */
.panel-title { color:var(--accent); font-weight:800; font-size:18px; }

/* small helper buttons */
.panel-btn { display:inline-block; padding:8px 12px; border-radius:8px; border:1px solid rgba(255,182,193,0.06); color:#f6dfe6; background:transparent; cursor:pointer; margin-right:8px; }

/* slide containers */
.view-wrap { position:relative; overflow:hidden; }
.view { min-height:20px; transition: transform 0.35s ease; }
.view.hidden-left { transform: translateX(-100%); }
.view.hidden-right { transform: translateX(100%); }
.view.visible { transform: translateX(0); }

/* ===== BACK TO TOP ===== */
#backToTop { position:fixed; bottom:24px; right:24px; background:var(--card-bg); color:var(--accent-strong); border:2px solid var(--accent-strong); border-radius:50%; width:48px; height:48px; cursor:pointer; opacity:0; visibility:hidden; box-shadow:0 0 12px rgba(255,182,193,0.18); transition:opacity 0.3s,visibility 0.3s, transform 0.12s; z-index:10002; display:flex; align-items:center; justify-content:center; }
#backToTop::before { content:''; display:inline-block; border-left:8px solid transparent; border-right:8px solid transparent; border-bottom:12px solid var(--accent-strong); transform: translateY(-2px); }
#backToTop.show { opacity:1; visibility:visible; transform: translateY(0); }

/* ===== MOBILE ===== */
@media (max-width: 600px) {
    .grid { grid-template-columns: repeat(3, 1fr); gap:12px; padding:12px; }
    .card img { height:160px; }
    #popupContent { flex-direction:column; align-items:center; gap:12px; text-align:center; }
    #popupContent img { max-width:160px; }
    .right-panel { max-width:100%; width:100%; }
}

/* small tweaks */
a { color: inherit; }
</style>
</head>
<body>
<div class="container">
    <header>
        <div style="display:flex; align-items:center; gap:12px;">
            <h1>Tyler's Manga Library</h1>
        </div>
        <div style="display:flex; align-items:center; gap:12px;">
            <div class="counter" style="margin:0 12px 0 0;">
                <span class="total" id="totalBooksTop"></span>
                <span class="read" id="readBooksTop" title="Click to filter read/unread"></span>
            </div>
            <div id="hamburgerBtn" class="hamburger" title="Open menu" aria-label="Open menu">
                <span class="bar"></span>
            </div>
        </div>
    </header>

    <input type="text" id="searchInput" onkeyup="searchLibrary()" placeholder="Search by title, author, publisher, ISBN..." />

    <div class="view-wrap" style="margin-top:6px;">
        <div id="libraryView" class="view visible">
            <div class="grid" id="bookGrid"></div>
        </div>
        <div id="wishlistView" class="view hidden-right" style="display:none;">
            <div style="display:flex; align-items:center; justify-content:space-between;">
                <div style="font-weight:800; color:var(--accent); margin-bottom:8px;">My Wishlist</div>
                <div>
                    <button class="panel-btn" onclick="refreshWishlist()">Refresh</button>
                    <button class="panel-btn" onclick="closePanel()">Close</button>
                </div>
            </div>
            <div class="grid" id="wishlistGrid"></div>
        </div>
    </div>

    <div class="counter" id="bookCountBottom" style="margin-top:6px;">
        <span class="total" id="totalBooksBottom"></span>
        <span class="read" id="readBooksBottom" title="Click to filter read/unread"></span>
    </div>
</div>

<!-- Popup overlay -->
<div id="popupOverlay">
    <div id="popupContent" role="dialog" aria-modal="true">
        <button id="popupClose" title="Close">&times;</button>
        <img id="popupImage" src="" alt="Cover">
        <div class="popup-info">
            <div class="title" id="popupTitle"></div>
            <div class="meta" id="popupMeta"></div>
            <div class="isbn" id="popupISBN"></div>
            <div id="popupActions" style="margin-top:6px;"></div>
        </div>
    </div>
</div>

<!-- Right panel (sliding) -->
<div id="rightPanel" class="right-panel" aria-hidden="true">
    <header>
        <div class="panel-title">Menu</div>
        <div><button onclick="closePanel()" class="panel-btn">Close</button></div>
    </header>
    <div style="padding-bottom:12px;">
        <button class="panel-btn" onclick="showLibrary()">Library</button>
        <button class="panel-btn" onclick="showWishlist()">Wishlist</button>
        <button class="panel-btn" onclick="toggleReadFilter()">Toggle Read Filter</button>
        <button class="panel-btn" onclick="location.reload()">Reload</button>
    </div>
    <hr style="border:none;border-top:1px solid rgba(255,182,193,0.04);margin:12px 0;">
    <div style="font-size:13px;color:#f3dfe6;margin-bottom:6px;">Wishlist actions</div>
    <div>
        <div style="color:#f0ced6;font-size:13px;margin-bottom:6px;">Use the app to add a wishlist item (Add to Wishlist).</div>
        <div style="font-size:12px;color:#e9d3db;">Wishlist items are managed by the desktop app and saved to wishlist.json</div>
    </div>
</div>

<button id="backToTop" title="Back to Top" aria-label="Back to top"></button>

<script>
/* Helper: load JSON files */
async function loadJSON(path) {
    try {
        const res = await fetch(path, {cache:"no-store"});
        if (!res.ok) return [];
        const data = await res.json();
        return data || [];
    } catch (e) {
        console.error("Failed to load", path, e);
        return [];
    }
}

/* Global state */
let booksLib = [];
let booksWish = [];
let readClickState = 0; // 0=all(default),1=only read,2=only unread

function renderCounters() {
    const totalTop = document.getElementById('totalBooksTop');
    const totalBottom = document.getElementById('totalBooksBottom');
    const readTop = document.getElementById('readBooksTop');
    const readBottom = document.getElementById('readBooksBottom');
    totalTop.innerText = `Total Books: ${booksLib.length}`;
    totalBottom.innerText = `Total Books: ${booksLib.length}`;
    // default color is inherited; only color when filtered
    const totalRead = booksLib.filter(b => b.Read === true || b.Read === "true").length;
    if (readClickState === 0) {
        readTop.style.color = ''; readBottom.style.color = '';
        readTop.innerText = `Books Read: ${totalRead}`;
        readBottom.innerText = `Books Read: ${totalRead}`;
    } else if (readClickState === 1) {
        readTop.style.color = '#32CD32'; readBottom.style.color = '#32CD32';
        const visibleRead = booksLib.filter(b => (b.Read === true || b.Read === "true")).length;
        readTop.innerText = `Books Read: ${visibleRead}`;
        readBottom.innerText = `Books Read: ${visibleRead}`;
    } else {
        readTop.style.color = '#FF5555'; readBottom.style.color = '#FF5555';
        const visibleUnread = booksLib.filter(b => !(b.Read === true || b.Read === "true")).length;
        readTop.innerText = `Books Not Read: ${visibleUnread}`;
        readBottom.innerText = `Books Not Read: ${visibleUnread}`;
    }
}

/* Render library grid */
function renderLibrary() {
    const grid = document.getElementById('bookGrid');
    grid.innerHTML = '';
    // sort similarly to python
    booksLib.sort((a,b)=> {
        function parseTitle(t) {
            t = (t||'').trim();
            let m = t.match(/^(.*?),?\s*(?:Vol\.|Volume)\s*(\d+)\b/i);
            if(!m) return {name:t.toLowerCase(), vol:0};
            return {name:m[1].trim().toLowerCase(), vol: parseInt(m[2]||"0",10)};
        }
        let aP = parseTitle(a.Title), bP = parseTitle(b.Title);
        let cmp = aP.name.localeCompare(bP.name);
        return cmp !== 0 ? cmp : aP.vol - bP.vol;
    });
    for (let b of booksLib) {
        let card = document.createElement('div');
        card.className = 'card' + (b.Read ? ' read' : '');
        card.innerHTML = `
            <img src="${b.Cover||'${PLACEHOLDER_IMAGE}'}" alt="Cover">
            <div class="title">${b.Title||''}</div>
            <div class="meta">${(b.Authors && b.Authors!=='Unknown'?b.Authors+'<br>':'') + (b.Publisher && b.Publisher!=='Unknown'?b.Publisher+'<br>':'') + (b.Date && b.Date!=='Unknown'?b.Date+'<br>':'')}</div>
            <div class="isbn">${b.ISBN||''}</div>
        `;
        card.onclick = () => showPopup(b, false);
        grid.appendChild(card);
    }
    renderCounters();
}

/* Render wishlist grid */
function renderWishlist() {
    const grid = document.getElementById('wishlistGrid');
    grid.innerHTML = '';
    // simple render, newest last
    booksWish.forEach(b => {
        let card = document.createElement('div');
        card.className = 'card' + (b.Read ? ' read' : '');
        card.innerHTML = `
            <img src="${b.Cover||'${PLACEHOLDER_IMAGE}'}" alt="Cover">
            <div class="title">${b.Title||''}</div>
            <div class="meta">${(b.Authors && b.Authors!=='Unknown'?b.Authors+'<br>':'') + (b.Date && b.Date!=='Unknown'?b.Date+'<br>':'')}</div>
            <div class="isbn">Wishlist</div>
        `;
        card.onclick = () => showPopup(b, true); // wishlist popup shows buy button
        grid.appendChild(card);
    });
}

/* Search + filter */
function searchLibrary() {
    let input = document.getElementById('searchInput').value.toLowerCase();
    const cards = document.getElementsByClassName('card');
    for (let card of cards) {
        const isRead = card.classList.contains('read');
        let visibleBySort = false;
        if (readClickState === 0) visibleBySort = true;
        else if (readClickState === 1 && isRead) visibleBySort = true;
        else if (readClickState === 2 && !isRead) visibleBySort = true;
        let visibleBySearch = input === '' || card.innerText.toLowerCase().includes(input);
        card.style.display = (visibleBySort && visibleBySearch) ? '' : 'none';
    }
    renderCounters();
}

/* Toggle read filter cycle */
function toggleReadFilter() {
    readClickState = (readClickState + 1) % 3;
    // visually update counters + reapply search
    searchLibrary();
}

/* Popup show */
function showPopup(book, isWishlist) {
    document.getElementById('popupOverlay').style.display = 'flex';
    const popup = document.getElementById('popupContent');
    if (book.Read === true || book.Read === "true") {
        popup.classList.add('read');
    } else {
        popup.classList.remove('read');
    }
    document.getElementById('popupImage').src = book.Cover || '${PLACEHOLDER_IMAGE}';
    document.getElementById('popupTitle').innerHTML = book.Title || '';
    let meta = '';
    if(book.Authors && book.Authors !== 'Unknown') meta += book.Authors + '<br>';
    if(book.Publisher && book.Publisher !== 'Unknown') meta += book.Publisher + '<br>';
    if(book.Date && book.Date !== 'Unknown') meta += book.Date + '<br>';
    document.getElementById('popupMeta').innerHTML = meta;
    document.getElementById('popupISBN').innerHTML = (book.ISBN || '') + (isWishlist ? ' (Wishlist)' : '');
    const actions = document.getElementById('popupActions');
    actions.innerHTML = '';
    if (isWishlist && book.BuyLink) {
        const a = document.createElement('a');
        a.href = book.BuyLink;
        a.target = '_blank';
        a.className = 'buy-btn';
        a.innerText = 'Buy on Amazon';
        actions.appendChild(a);
    } else {
        // For library books optionally show add-to-wishlist text
        const info = document.createElement('div');
        info.style.fontSize = '12px';
        info.style.color = '#e8ced6';
        info.innerText = isWishlist ? '' : 'Manage read status from the desktop app.';
        actions.appendChild(info);
    }
    if (book.Read) {
        document.getElementById('popupMeta').innerHTML += '<br><span style="color:#6fcf97;">âœ” Read</span>';
    }
}

/* Close popup */
document.getElementById('popupClose').onclick = () => {
    document.getElementById('popupOverlay').style.display = 'none';
}

/* Hamburger + right panel behavior */
const hamburger = document.getElementById('hamburgerBtn');
const rightPanel = document.getElementById('rightPanel');
hamburger.addEventListener('click', () => {
    hamburger.classList.toggle('open');
    const open = hamburger.classList.contains('open');
    if (open) {
        rightPanel.classList.add('open');
        rightPanel.setAttribute('aria-hidden','false');
    } else {
        rightPanel.classList.remove('open');
        rightPanel.setAttribute('aria-hidden','true');
    }
});
function closePanel() {
    hamburger.classList.remove('open');
    rightPanel.classList.remove('open');
    rightPanel.setAttribute('aria-hidden','true');
}
function showWishlist() {
    // slide view to wishlist
    document.getElementById('libraryView').style.display = 'none';
    const wv = document.getElementById('wishlistView');
    wv.style.display = '';
    setTimeout(()=> { wv.classList.remove('hidden-right'); wv.classList.add('visible'); }, 10);
    closePanel();
    refreshWishlist();
}
function showLibrary() {
    const wv = document.getElementById('wishlistView');
    if (wv) { wv.classList.add('hidden-right'); wv.classList.remove('visible'); setTimeout(()=> { wv.style.display='none'; document.getElementById('libraryView').style.display=''; }, 250); }
    closePanel();
}

/* back to top */
const backToTopBtn = document.getElementById('backToTop');
window.addEventListener('scroll', () => {
    if (window.scrollY > 250) { backToTopBtn.classList.add('show'); } else { backToTopBtn.classList.remove('show'); }
});
backToTopBtn.addEventListener('click', () => window.scrollTo({top:0, behavior:'smooth'}));

/* Load both JSON files and render */
async function loadAll() {
    booksLib = await loadJSON('lib.json');
    // ensure Read field exists
    booksLib = booksLib.map(b => { if (b.Read === undefined) b.Read = false; return b; });
    booksWish = await loadJSON('wishlist.json');
    renderLibrary();
    renderWishlist();
}
loadAll();

function refreshWishlist() {
    loadJSON('wishlist.json').then(d=> { booksWish = d || []; renderWishlist(); });
}

/* small utility for python-created BuyLink to work */
</script>
</body>
</html>