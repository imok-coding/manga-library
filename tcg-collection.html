<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tyler's TCG Collection</title>
  <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#1e0d14">

  <style>
    :root {
      --bg: #1e0d14;
      --bg-deep: #0b0610;
      --card-bg: rgba(20, 10, 18, 0.9);
      --accent: #ffb6c1;
      --accent-soft: #ffd1dc;
      --border-soft: rgba(255, 182, 193, 0.4);
      --text-main: #ffffff;
      --text-soft: #d0c5cf;
      --danger: #ff4b6a;
      --shadow-soft: 0 12px 30px rgba(0, 0, 0, 0.6);
      --radius-lg: 18px;
      --radius-md: 12px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg) url("https://imgur.com/7co2elX.png") center top / cover no-repeat fixed;
      color: var(--text-main);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .page-shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px 16px 40px;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
    }

    .title-block h1 {
      margin: 0;
      font-size: 1.8rem;
      letter-spacing: 0.04em;
      color: var(--accent);
      text-align: left;
    }

    .title-block p {
      margin: 4px 0 0;
      font-size: 0.9rem;
      color: var(--text-soft);
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,182,193,0.35);
      background: rgba(11, 6, 16, 0.8);
      color: var(--accent-soft);
      text-decoration: none;
      font-size: 0.85rem;
      box-shadow: 0 8px 18px rgba(0,0,0,0.5);
    }

    .back-link span {
      font-size: 1.1rem;
    }

    .auth-status {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      justify-content: flex-end;
    }

    .auth-status small {
      color: var(--text-soft);
      font-size: 0.8rem;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid var(--accent-soft);
      background: rgba(30,13,20,0.9);
      color: var(--accent-soft);
      padding: 6px 12px;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .btn.secondary {
      border-color: rgba(255,255,255,0.25);
      color: #fff;
      background: rgba(11,6,16,0.9);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    /* FILTER BAR */
    .filters {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255,255,255,0.08);
      background: linear-gradient(135deg, rgba(15,8,19,0.95), rgba(25,10,20,0.92));
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .filters-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .chip {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,182,193,0.25);
      font-size: 0.8rem;
      color: var(--text-soft);
      cursor: pointer;
      background: rgba(11,6,16,0.8);
    }

    .chip.active {
      background: var(--accent);
      color: #2b0f1d;
      border-color: var(--accent);
      font-weight: 600;
    }

    .search-input {
      background: rgba(6,3,9,0.9);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 999px;
      padding: 6px 10px;
      color: var(--text-main);
      font-size: 0.85rem;
      min-width: 160px;
    }

    .search-input::placeholder {
      color: var(--text-soft);
    }

    /* GRID */
    .cards-grid {
      margin-top: 18px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 14px;
    }

    .tcg-card {
      position: relative;
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at 0 0, rgba(255,182,193,0.2), rgba(5,0,8,0.95));
      border: 1px solid var(--border-soft);
      padding: 8px;
      box-shadow: var(--shadow-soft);
      cursor: pointer;
      overflow: hidden;
      transform: translateY(0);
      transition: transform 0.15s ease-out, box-shadow 0.15s ease-out, border-color 0.15s;
    }

    .tcg-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 16px 40px rgba(0,0,0,0.8);
      border-color: var(--accent-soft);
    }

    .card-game-tag {
      position: absolute;
      top: 6px;
      left: 6px;
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(0,0,0,0.65);
      color: var(--accent-soft);
      border: 1px solid rgba(255,255,255,0.25);
    }

    .card-thumb-wrap {
      width: 100%;
      aspect-ratio: 3/4;
      border-radius: var(--radius-md);
      overflow: hidden;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 6px;
    }

    .card-thumb {
      max-width: 100%;
      max-height: 100%;
      display: block;
    }

    .card-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 0.8rem;
    }

    .card-name {
      font-weight: 600;
      color: var(--accent-soft);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .card-set {
      color: var(--text-soft);
      font-size: 0.75rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .card-bottom-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 4px;
      font-size: 0.75rem;
    }

    .price-pill {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(11,6,16,0.95);
      border: 1px solid rgba(255,255,255,0.18);
      color: var(--accent-soft);
    }

    .owned-badge {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(255,182,193,0.15);
      border: 1px solid rgba(255,182,193,0.4);
      color: var(--accent-soft);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .owned-badge button {
      border: none;
      background: transparent;
      color: inherit;
      font-size: 0.9rem;
      cursor: pointer;
      padding: 0 2px;
    }

    .owned-badge button:disabled {
      opacity: 0.4;
      cursor: default;
    }

    /* EMPTY STATE */
    .empty-state {
      margin-top: 40px;
      text-align: center;
      color: var(--text-soft);
      font-size: 0.9rem;
    }

    /* MODAL */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(3,0,5,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      backdrop-filter: blur(8px);
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal-card {
      width: min(820px, 100% - 32px);
      max-height: calc(100vh - 40px);
      background: radial-gradient(circle at 0 0, rgba(255,182,193,0.16), rgba(6,0,10,0.98));
      border-radius: 20px;
      padding: 16px 16px 18px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.9);
      position: relative;
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      gap: 14px;
    }

    @media (max-width: 780px) {
      .modal-card {
        grid-template-columns: minmax(0, 1fr);
        max-height: calc(100vh - 24px);
      }
    }

    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.25);
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 4px 8px;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .modal-title {
      margin: 0;
      font-size: 1.1rem;
      color: var(--accent-soft);
    }

    .modal-subtitle {
      margin: 2px 0 8px;
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .modal-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    .modal-tag {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(11,6,16,0.9);
      color: var(--accent-soft);
    }

    .modal-price {
      font-size: 0.95rem;
      color: var(--accent-soft);
      margin-bottom: 6px;
    }

    .modal-owned {
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-bottom: 6px;
    }

    .modal-body-text {
      font-size: 0.8rem;
      color: var(--text-soft);
      line-height: 1.5;
    }

    /* FLIPPER */
    .flip-shell {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .flip-container {
      width: 100%;
      max-width: 280px;
      aspect-ratio: 3/4;
      perspective: 1400px;
    }

    .flip-inner {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.6s ease;
      cursor: pointer;
    }

    .flip-inner.flipped {
      transform: rotateY(180deg);
    }

    .flip-face {
      position: absolute;
      inset: 0;
      backface-visibility: hidden;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--shadow-soft);
    }

    .flip-front {
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .flip-front img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .flip-back {
      background: radial-gradient(circle at 0 0, rgba(255,182,193,0.2), rgba(9,2,16,0.98));
      transform: rotateY(180deg);
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .flip-back h3 {
      margin: 0 0 4px;
      font-size: 0.9rem;
      color: var(--accent-soft);
    }

    .flip-hint {
      margin-top: 6px;
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    .modal-right-scroll {
      overflow-y: auto;
      padding-right: 4px;
    }

    @media (max-width: 780px) {
      .modal-card {
        grid-template-columns: minmax(0, 1fr);
      }
      .modal-right-scroll {
        max-height: 200px;
      }
    }
  </style>
</head>
<body>
  <div class="page-shell">
    <header>
      <div class="title-block">
        <a href="index.html" class="back-link">
          <span>&lt;</span> Back to Library
        </a>
        <h1>Tyler's TCG Collection</h1>
        <p>Pokémon &amp; One Piece cards with live collection counts.</p>
      </div>
      <div class="auth-status">
        <small id="authStatusText">Checking sign-in…</small>
        <button class="btn secondary" id="authSignInBtn" style="display:none;">Sign in with Google</button>
        <button class="btn secondary" id="authSignOutBtn" style="display:none;">Sign out</button>
      </div>
    </header>

    <section class="filters">
      <div class="filters-group">
        <span style="font-size:0.8rem;color:var(--text-soft);">Game:</span>
        <button class="chip active" data-game-filter="all">All</button>
        <button class="chip" data-game-filter="pokemon">Pokémon</button>
        <button class="chip" data-game-filter="onepiece">One Piece</button>
      </div>
      <div class="filters-group">
        <input id="searchInput" class="search-input" type="search" placeholder="Search by name, set…" />
      </div>
    </section>

    <section id="cardsSection">
      <div id="cardsGrid" class="cards-grid"></div>
      <div id="emptyState" class="empty-state" style="display:none;">
        No cards in your TCG collection yet.<br>
        <span style="font-size:0.8rem;">Sign in as admin and use <strong>tcg-admin.html</strong> to import cards.</span>
      </div>
    </section>
  </div>

  <!-- Modal -->
  <div id="cardModal" class="modal-backdrop">
    <div class="modal-card">
      <button class="modal-close" id="modalCloseBtn">Close ✕</button>
      <div class="flip-shell">
        <div class="flip-container">
          <div class="flip-inner" id="flipInner">
            <div class="flip-face flip-front">
              <img id="modalImage" src="" alt="Card image">
            </div>
            <div class="flip-face flip-back">
              <h3 id="modalBackName"></h3>
              <div id="modalBackGame"></div>
              <div id="modalBackSet"></div>
              <div id="modalBackRarity"></div>
              <div id="modalBackCode"></div>
              <div id="modalBackPrice"></div>
              <div id="modalBackOwned"></div>
              <div class="flip-hint">
                Tap/click card to flip front/back.
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-right-scroll">
        <h2 class="modal-title" id="modalTitle"></h2>
        <div class="modal-subtitle" id="modalSubtitle"></div>
        <div class="modal-tags" id="modalTags"></div>
        <div class="modal-price" id="modalPrice"></div>
        <div class="modal-owned" id="modalOwnedDetail"></div>
        <div class="modal-body-text">
          This view is meant as a collector's showcase. More per-card stats can be added later
          (grades, language, condition, etc.) and stored in Firestore.
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // ===== Firebase config (from index.html) =====
    const firebaseConfig = {
      apiKey: "AIzaSyCOOnlmEcAcJywsS93LLfLSywy9ENqnppM",
      authDomain: "tyler-manga-library.firebaseapp.com",
      projectId: "tyler-manga-library",
      storageBucket: "tyler-manga-library.firebasestorage.app",
      messagingSenderId: "307412068362",
      appId: "1:307412068362:web:6cfe5666187439dfa757f3"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      getDocs,
      updateDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    const ADMIN_EMAIL = "imokissick@gmail.com";
    let isAdmin = false;
    let currentUser = null;
    let allCards = [];

    // DOM
    const authStatusText = document.getElementById("authStatusText");
    const authSignInBtn = document.getElementById("authSignInBtn");
    const authSignOutBtn = document.getElementById("authSignOutBtn");

    const cardsGrid = document.getElementById("cardsGrid");
    const emptyState = document.getElementById("emptyState");
    const searchInput = document.getElementById("searchInput");

    const chipButtons = Array.from(document.querySelectorAll(".chip[data-game-filter]"));

    const cardModal = document.getElementById("cardModal");
    const modalCloseBtn = document.getElementById("modalCloseBtn");
    const flipInner = document.getElementById("flipInner");
    const modalImage = document.getElementById("modalImage");
    const modalBackName = document.getElementById("modalBackName");
    const modalBackGame = document.getElementById("modalBackGame");
    const modalBackSet = document.getElementById("modalBackSet");
    const modalBackRarity = document.getElementById("modalBackRarity");
    const modalBackCode = document.getElementById("modalBackCode");
    const modalBackPrice = document.getElementById("modalBackPrice");
    const modalBackOwned = document.getElementById("modalBackOwned");
    const modalTitle = document.getElementById("modalTitle");
    const modalSubtitle = document.getElementById("modalSubtitle");
    const modalTags = document.getElementById("modalTags");
    const modalPrice = document.getElementById("modalPrice");
    const modalOwnedDetail = document.getElementById("modalOwnedDetail");

    let activeGameFilter = "all";

    // ===== Auth handling =====
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (user) {
        isAdmin = user.email === ADMIN_EMAIL;
        authStatusText.textContent = isAdmin
          ? `Signed in as admin: ${user.email}`
          : `Signed in: ${user.email}`;
        authSignInBtn.style.display = "none";
        authSignOutBtn.style.display = "inline-flex";
      } else {
        currentUser = null;
        isAdmin = false;
        authStatusText.textContent = "Not signed in.";
        authSignInBtn.style.display = "inline-flex";
        authSignOutBtn.style.display = "none";
      }
      await loadCards();
    });

    authSignInBtn.addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        console.error(err);
        alert("Sign-in failed. See console.");
      }
    });

    authSignOutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
      } catch (err) {
        console.error(err);
        alert("Sign-out failed.");
      }
    });

    // ===== Firestore: load cards =====
    async function loadCards() {
      try {
        const snap = await getDocs(collection(db, "tcgCards"));
        allCards = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderCards();
      } catch (err) {
        console.error("Failed to load tcgCards:", err);
        cardsGrid.innerHTML = "";
        emptyState.style.display = "block";
      }
    }

    function formatGameLabel(game) {
      if (game === "pokemon") return "Pokémon TCG";
      if (game === "onepiece") return "One Piece TCG";
      return game || "Unknown";
    }

    function renderCards() {
      const query = (searchInput.value || "").toLowerCase().trim();
      let filtered = allCards.slice();

      if (activeGameFilter !== "all") {
        filtered = filtered.filter(c => (c.game || "").toLowerCase() === activeGameFilter);
      }

      if (query) {
        filtered = filtered.filter(c => {
          const name = (c.name || "").toLowerCase();
          const setName = (c.setName || "").toLowerCase();
          const code = (c.code || "").toLowerCase();
          return (
            name.includes(query) ||
            setName.includes(query) ||
            code.includes(query)
          );
        });
      }

      if (!filtered.length) {
        cardsGrid.innerHTML = "";
        emptyState.style.display = "block";
        return;
      }

      emptyState.style.display = "none";
      cardsGrid.innerHTML = "";

      filtered.forEach(card => {
        const cardEl = document.createElement("article");
        cardEl.className = "tcg-card";
        cardEl.dataset.id = card.id;

        const gameLabel = formatGameLabel(card.game);
        const thumb = card.imageSmall || card.imageLarge || "";
        const price = typeof card.price === "number" ? card.price : 0;
        const owned = typeof card.owned === "number" ? card.owned : 0;

        cardEl.innerHTML = `
          <div class="card-game-tag">${gameLabel}</div>
          <div class="card-thumb-wrap">
            ${thumb ? `<img class="card-thumb" src="${thumb}" alt="${card.name || "Card"}">` : ""}
          </div>
          <div class="card-meta">
            <div class="card-name" title="${card.name || ""}">${card.name || "Unknown Card"}</div>
            <div class="card-set" title="${card.setName || ""}">${card.setName || ""}</div>
            <div class="card-bottom-row">
              <div class="price-pill">$${price.toFixed(2)}</div>
              <div class="owned-badge">
                <span>Owned: <strong id="owned-${card.id}">${owned}</strong></span>
                ${isAdmin ? `
                  <button data-owned-dec="-1" aria-label="Decrease">-</button>
                  <button data-owned-inc="1" aria-label="Increase">+</button>
                ` : ""}
              </div>
            </div>
          </div>
        `;

        // Click -> open modal (but not when clicking owned +/-)
        cardEl.addEventListener("click", (ev) => {
          const t = ev.target;
          if (t.closest("[data-owned-dec]") || t.closest("[data-owned-inc]")) return;
          openModal(card);
        });

        if (isAdmin) {
          const decBtn = cardEl.querySelector("[data-owned-dec]");
          const incBtn = cardEl.querySelector("[data-owned-inc]");

          decBtn.addEventListener("click", ev => {
            ev.stopPropagation();
            changeOwned(card, -1);
          });
          incBtn.addEventListener("click", ev => {
            ev.stopPropagation();
            changeOwned(card, +1);
          });
        }

        cardsGrid.appendChild(cardEl);
      });
    }

    async function changeOwned(card, delta) {
      const current = typeof card.owned === "number" ? card.owned : 0;
      const next = Math.max(0, current + delta);
      if (next === current) return;

      try {
        await updateDoc(doc(db, "tcgCards", card.id), { owned: next });
        card.owned = next;
        const badgeVal = document.getElementById(`owned-${card.id}`);
        if (badgeVal) badgeVal.textContent = String(next);
        if (cardModal.classList.contains("show") && card.id === cardModal.dataset.cardId) {
          modalOwnedDetail.textContent = `You own ${next} copie(s) of this card.`;
          modalBackOwned.textContent = `Owned: ${next}`;
        }
      } catch (err) {
        console.error("Failed to update owned:", err);
        alert("Failed to update owned count.");
      }
    }

    // Filters
    chipButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const val = btn.dataset.gameFilter;
        activeGameFilter = val;
        chipButtons.forEach(b => b.classList.toggle("active", b === btn));
        renderCards();
      });
    });

    searchInput.addEventListener("input", () => {
      renderCards();
    });

    // Modal
    function openModal(card) {
      const price = typeof card.price === "number" ? card.price : 0;
      const owned = typeof card.owned === "number" ? card.owned : 0;
      const gameLabel = formatGameLabel(card.game);

      cardModal.dataset.cardId = card.id;

      modalImage.src = card.imageLarge || card.imageSmall || "";
      modalImage.alt = card.name || "Card";

      modalBackName.textContent = card.name || "";
      modalBackGame.textContent = `Game: ${gameLabel}`;
      modalBackSet.textContent = card.setName ? `Set: ${card.setName}` : "";
      modalBackRarity.textContent = card.rarity ? `Rarity: ${card.rarity}` : "";
      modalBackCode.textContent = card.code ? `Code: ${card.code}` : "";
      modalBackPrice.textContent = `Price (stored): $${price.toFixed(2)}`;
      modalBackOwned.textContent = `Owned: ${owned}`;

      modalTitle.textContent = card.name || "Card detail";
      modalSubtitle.textContent = `${gameLabel}${card.setName ? " · " + card.setName : ""}`;
      modalTags.innerHTML = "";
      if (card.rarity) {
        const t = document.createElement("span");
        t.className = "modal-tag";
        t.textContent = card.rarity;
        modalTags.appendChild(t);
      }
      if (card.code) {
        const t = document.createElement("span");
        t.className = "modal-tag";
        t.textContent = card.code;
        modalTags.appendChild(t);
      }

      modalPrice.textContent = `Stored price: $${price.toFixed(2)}`;
      modalOwnedDetail.textContent = `You own ${owned} copie(s) of this card.`;

      flipInner.classList.remove("flipped");
      cardModal.classList.add("show");
    }

    modalCloseBtn.addEventListener("click", () => {
      cardModal.classList.remove("show");
    });

    cardModal.addEventListener("click", (ev) => {
      if (ev.target === cardModal) {
        cardModal.classList.remove("show");
      }
    });

    flipInner.addEventListener("click", () => {
      flipInner.classList.toggle("flipped");
    });
  </script>
</body>
</html>
