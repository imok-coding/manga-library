<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TCG Admin Importer</title>
  <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#1e0d14">

  <style>
    :root {
      --bg: #1e0d14;
      --bg-deep: #0b0610;
      --panel: rgba(9,2,16,0.95);
      --accent: #ffb6c1;
      --accent-soft: #ffd1dc;
      --text-main: #ffffff;
      --text-soft: #d0c5cf;
      --danger: #ff4b6a;
      --border-soft: rgba(255,182,193,0.35);
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 16px 40px rgba(0,0,0,0.8);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg) url("https://imgur.com/7co2elX.png") center top / cover no-repeat fixed;
      color: var(--text-main);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .page-shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px 16px 40px;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }

    .title-block h1 {
      margin: 0;
      font-size: 1.8rem;
      color: var(--accent);
    }

    .title-block p {
      margin: 4px 0 0;
      font-size: 0.9rem;
      color: var(--text-soft);
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,182,193,0.35);
      background: rgba(11,6,16,0.9);
      color: var(--accent-soft);
      text-decoration: none;
      font-size: 0.8rem;
      margin-bottom: 4px;
    }

    .back-link span {
      font-size: 1.1rem;
    }

    .auth-status {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      justify-content: flex-end;
    }

    .auth-status small {
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .btn {
      border-radius: 999px;
      border: 1px solid var(--accent-soft);
      background: rgba(30,13,20,0.95);
      color: var(--accent-soft);
      padding: 6px 12px;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .btn.secondary {
      border-color: rgba(255,255,255,0.25);
      color: #fff;
      background: rgba(11,6,16,0.95);
    }

    .btn.danger {
      border-color: var(--danger);
      color: #fff;
      background: rgba(120,15,35,0.95);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.3fr);
      gap: 16px;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .panel {
      background: var(--panel);
      border-radius: var(--radius-lg);
      padding: 14px 14px 16px;
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: var(--shadow-soft);
    }

    .panel-title {
      font-size: 1rem;
      font-weight: 600;
      margin: 0 0 8px;
      color: var(--accent-soft);
    }

    .panel-sub {
      font-size: 0.8rem;
      color: var(--text-soft);
      margin: 0 0 10px;
    }

    .field-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }

    label {
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    select, input[type="text"], input[type="number"] {
      background: rgba(6,3,9,0.95);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 999px;
      color: var(--text-main);
      font-size: 0.85rem;
      padding: 6px 10px;
    }

    input::placeholder {
      color: var(--text-soft);
    }

    .grow {
      flex: 1 1 160px;
    }

    .results-grid {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      max-height: 520px;
      overflow-y: auto;
    }

    .result-card {
      border-radius: var(--radius-md);
      border: 1px solid rgba(255,255,255,0.18);
      background: radial-gradient(circle at 0 0, rgba(255,182,193,0.1), rgba(6,0,10,0.98));
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .result-header {
      display: flex;
      gap: 8px;
    }

    .result-thumb-wrap {
      width: 72px;
      min-width: 72px;
      aspect-ratio: 3/4;
      border-radius: 10px;
      overflow: hidden;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .result-thumb-wrap img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .result-meta {
      flex: 1;
      min-width: 0;
      font-size: 0.78rem;
    }

    .result-name {
      font-weight: 600;
      color: var(--accent-soft);
      margin-bottom: 2px;
    }

    .result-line {
      color: var(--text-soft);
      font-size: 0.75rem;
    }

    .result-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      justify-content: space-between;
      margin-top: 4px;
    }

    .small-input {
      width: 90px;
    }

    .tag {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--accent-soft);
      background: rgba(11,6,16,0.95);
    }

    .log-area {
      margin-top: 8px;
      padding: 8px;
      border-radius: 10px;
      background: rgba(0,0,0,0.7);
      font-size: 0.75rem;
      color: var(--text-soft);
      max-height: 140px;
      overflow-y: auto;
    }

    .log-line {
      margin-bottom: 2px;
    }

    .danger-text {
      color: var(--danger);
    }

    .existing-list {
      margin-top: 8px;
      max-height: 520px;
      overflow-y: auto;
      font-size: 0.8rem;
    }

    .existing-item {
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.14);
      padding: 8px;
      margin-bottom: 6px;
      display: flex;
      gap: 8px;
      align-items: center;
      background: rgba(6,0,10,0.95);
    }

    .existing-img {
      width: 52px;
      min-width: 52px;
      aspect-ratio: 3/4;
      border-radius: 8px;
      overflow: hidden;
      background: #000;
    }

    .existing-img img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .existing-meta {
      flex: 1;
      min-width: 0;
    }

    .existing-name {
      font-weight: 600;
      color: var(--accent-soft);
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .existing-sub {
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    .existing-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .existing-actions input {
      width: 80px;
      font-size: 0.75rem;
      padding: 4px 6px;
      border-radius: 999px;
    }
  </style>
</head>
<body>
  <div class="page-shell">
    <header>
      <div class="title-block">
        <a href="tcg.html" class="back-link"><span>&lt;</span> Back to TCG viewer</a>
        <h1>TCG Admin Importer</h1>
        <p>Search Pokémon &amp; One Piece cards via API and push them into Firestore.</p>
      </div>
      <div class="auth-status">
        <small id="authStatusText">Checking sign-in…</small>
        <button class="btn secondary" id="authSignInBtn" style="display:none;">Sign in with Google</button>
        <button class="btn secondary" id="authSignOutBtn" style="display:none;">Sign out</button>
      </div>
    </header>

    <div id="notAdminMessage" class="panel danger-text" style="display:none; text-align:center;">
      Admin-only page. Sign in with the same account that’s admin on your main library.
    </div>

    <main id="mainContent" style="display:none;">
      <!-- Left: Search + API results -->
      <section class="panel">
        <h2 class="panel-title">Search &amp; Import from API TCG</h2>
        <p class="panel-sub">
          Uses <strong>apitcg.com</strong> for card images &amp; metadata (Pokémon &amp; One Piece).
          Price is stored locally for now; you can later wire a backend for live pricing.
        </p>

        <div class="field-row">
          <label>Game:</label>
          <select id="gameSelect">
            <option value="pokemon">Pokémon</option>
            <option value="onepiece">One Piece</option>
          </select>
        </div>

        <div class="field-row">
          <label class="grow">
            <span style="display:block;font-size:0.75rem;color:var(--text-soft);">Search by name or exact ID</span>
            <input type="text" id="searchQuery" class="grow" placeholder="e.g. charizard / OP01-001 / luffy" />
          </label>
        </div>

        <div class="field-row">
          <button class="btn" id="searchBtn">Search</button>
          <small style="color:var(--text-soft);">
            Simple rule: if it looks like a code (OPxx-xxx), search by ID; otherwise by name.
          </small>
        </div>

        <div id="searchStatus" class="panel-sub" style="margin-top:4px;"></div>

        <div id="resultsGrid" class="results-grid"></div>

        <div class="log-area" id="logArea"></div>
      </section>

      <!-- Right: Existing Firestore cards & quick editing -->
      <section class="panel">
        <h2 class="panel-title">Existing TCG Cards (Firestore)</h2>
        <p class="panel-sub">
          Quick-edit stored price &amp; owned count for cards already in <code>tcgCards</code>.
        </p>

        <div class="field-row">
          <label>Filter game:</label>
          <select id="existingGameFilter">
            <option value="all">All</option>
            <option value="pokemon">Pokémon</option>
            <option value="onepiece">One Piece</option>
          </select>
          <input type="text" id="existingSearch" class="grow" placeholder="Search by name / set / code" />
        </div>

        <div id="existingList" class="existing-list"></div>
      </section>
    </main>
  </div>

  <script type="module">
    // --- Firebase setup (keep your config) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import {
        getFirestore,
        collection,
        addDoc,
    } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCOOnlmEcAcJywsS93LLfLSywy9ENqnppM",
        authDomain: "tyler-manga-library.firebaseapp.com",
        projectId: "tyler-manga-library",
        storageBucket: "tyler-manga-library.firebasestorage.app",
        messagingSenderId: "307412068362",
        appId: "1:307412068362:web:6cfe5666187439dfa757f3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- API bases ---
    const POKEMON_API_BASE = "https://api.pokemontcg.io/v2/cards";
    const OP_API_BASE = "https://optcgapi.com/api";

    // --- Simple logger utility (optional) ---
    const logArea = document.getElementById("log");
    function log(msg) {
        if (logArea) {
        const line = document.createElement("div");
        line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        logArea.prepend(line);
        } else {
        console.log(msg);
        }
    }

    // --- Helpers: detect if One Piece query is a card code like OP01-001/ST04-016 ---
    function looksLikeOPCode(value) {
        // Covers OP01-001, EB01-003, ST04-016, PRB01-001, etc.
        return /^[A-Z]{2,4}\d{2}-\d{3}$/i.test(value.trim());
    }

    // --- Fetch functions ---

    async function searchPokemonByName(name) {
        const q = `name:${name}`;
        const url = `${POKEMON_API_BASE}?q=${encodeURIComponent(q)}&pageSize=20`;
        log(`Request (Pokémon): ${url}`);

        const res = await fetch(url);
        if (!res.ok) {
        throw new Error(`Pokémon API error: ${res.status} ${res.statusText}`);
        }
        const data = await res.json();
        return (data && data.data) || [];
    }

    async function fetchOnePieceByCode(code) {
        const cardId = code.trim().toUpperCase();
        const url = `${OP_API_BASE}/sets/card/${cardId}/`;
        log(`Request (One Piece): ${url}`);

        const res = await fetch(url);
        if (!res.ok) {
        throw new Error(`OPTCG API error: ${res.status} ${res.statusText}`);
        }
        const data = await res.json();
        // This endpoint returns a list (base + alt arts etc.)
        return Array.isArray(data) ? data : [];
    }

    // --- Mapping functions (normalize to your Firestore schema) ---

    function mapPokemonCard(apiCard) {
        // Try to pull a reasonable market price from tcgplayer.prices
        let marketPrice = 0;
        const prices = apiCard.tcgplayer?.prices || {};
        for (const key of Object.keys(prices)) {
        const p = prices[key];
        if (p && typeof p.market === "number") {
            marketPrice = p.market;
            break;
        }
        }

        return {
        game: "pokemon",
        apiId: apiCard.id,
        code: apiCard.number || "",
        name: apiCard.name || "",
        setName: apiCard.set?.name || "",
        rarity: apiCard.rarity || "",
        imageSmall: apiCard.images?.small || "",
        imageLarge: apiCard.images?.large || "",
        // Pokémon: we DO use market price
        price: marketPrice,
        owned: 0,
        createdAt: Date.now()
        };
    }

    function mapOnePieceCard(apiCard) {
        // `apiCard` shape based on OPTCG sample:
        // inventory_price, market_price, card_name, set_name, card_set_id, card_image, etc.
        return {
        game: "onepiece",
        apiId: apiCard.card_image_id || apiCard.card_set_id,
        code: apiCard.card_set_id || "",
        name: apiCard.card_name || "",
        setName: apiCard.set_name || "",
        rarity: apiCard.rarity || "",
        imageSmall: apiCard.card_image || "",
        imageLarge: apiCard.card_image || "",
        // One Piece: **no auto pricing** right now
        price: 0,
        owned: 0,
        createdAt: Date.now()
        };
    }

    // --- DOM elements (adjust IDs to your markup) ---
    const gameSelect = document.getElementById("gameSelect");   // e.g. <select id="gameSelect"><option value="pokemon">...</option>...
    const queryInput = document.getElementById("cardQuery");    // e.g. search box
    const resultsContainer = document.getElementById("results"); // container to show search results

    // Render results to the page with "Import" buttons
    function renderResults(cards, game) {
        if (!resultsContainer) return;
        resultsContainer.innerHTML = "";

        if (!cards.length) {
        resultsContainer.textContent = "No cards found.";
        return;
        }

        cards.forEach((card) => {
        const cardDiv = document.createElement("div");
        cardDiv.className = "admin-card-result";

        const title = document.createElement("div");
        title.className = "card-title";
        title.textContent = card.name;

        const subtitle = document.createElement("div");
        subtitle.className = "card-subtitle";
        subtitle.textContent = `${card.setName} • ${card.rarity} • Code: ${card.code}`;

        const img = document.createElement("img");
        img.className = "card-thumb";
        img.src = card.imageSmall || card.imageLarge || "";
        img.alt = card.name;

        const importBtn = document.createElement("button");
        importBtn.textContent = "Import to Firestore";
        importBtn.addEventListener("click", () => importCard(card));

        cardDiv.appendChild(img);
        cardDiv.appendChild(title);
        cardDiv.appendChild(subtitle);
        cardDiv.appendChild(importBtn);
        resultsContainer.appendChild(cardDiv);
        });
    }

    async function importCard(card) {
        try {
        await addDoc(collection(db, "tcgCards"), card);
        log(`Imported card: [${card.game}] ${card.name} (${card.code})`);
        alert(`Imported: ${card.name}`);
        } catch (err) {
        console.error(err);
        log(`Error importing card: ${err.message}`);
        alert("Failed to import card. Check console/log.");
        }
    }

    // --- Main search handler ---

    const searchBtn = document.getElementById("searchBtn"); // e.g. <button id="searchBtn">Search</button>

    if (searchBtn) {
        searchBtn.addEventListener("click", async () => {
        const game = gameSelect ? gameSelect.value : "pokemon";
        const query = (queryInput?.value || "").trim();

        if (!query) {
            alert("Enter a card name (Pokémon) or card code (One Piece, e.g. OP01-001).");
            return;
        }

        try {
            let cards = [];

            if (game === "pokemon") {
            const apiCards = await searchPokemonByName(query);
            cards = apiCards.map(mapPokemonCard);
            } else if (game === "onepiece") {
            if (!looksLikeOPCode(query)) {
                alert("For now, search One Piece by card code (e.g. OP01-001, ST04-016).");
                return;
            }
            const apiCards = await fetchOnePieceByCode(query);
            cards = apiCards.map(mapOnePieceCard);
            }

            renderResults(cards, game);
        } catch (err) {
            console.error(err);
            log(`Error: Failed to fetch (${err.message})`);
            alert("API request failed. Check log/console for details.");
        }
        });
    }
  </script>

</body>
</html>
